{% extends "base.html" %}
{% block title %}Quiz Dashboard - {{ quiz.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Quiz Header -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-0">
                        <i class="fas fa-quiz"></i> {{ quiz.name }}
                    </h4>
                    <small>Event: {{ event.name }}</small>
                </div>
                <div class="col-auto">
                    <a href="{{ url_for('generate_quiz_qr', event_id=event.id, quiz_id=quiz.id) }}" class="btn btn-light me-2">
                        <i class="fas fa-qrcode"></i> Show QR Code
                    </a>
                    <button class="btn btn-outline-light" onclick="deleteQuiz()">
                        <i class="fas fa-trash"></i> Delete Quiz
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="border rounded p-3">
                        <h5 class="text-primary mb-1">{{ total_questions }}</h5>
                        <small class="text-muted">Questions</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3">
                        <h5 class="text-info mb-1">{{ quiz.timer_per_question }}s</h5>
                        <small class="text-muted">Per Question</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3">
                        <h5 class="text-success mb-1">{{ total_participants }}</h5>
                        <small class="text-muted">Participants</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="border rounded p-3">
                        <h5 class="text-warning mb-1">{{ completed_participants }}</h5>
                        <small class="text-muted">Completed</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Questions Management -->
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle"></i> Manage Questions
                    </h5>
                </div>
                <div class="card-body">
                    {% if total_questions == 0 %}
                    <div class="text-center py-4">
                        <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No questions uploaded yet</p>
                        <p class="small">Upload questions using the CSV template below</p>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> {{ total_questions }} questions ready
                    </div>
                    {% endif %}

                    <!-- Upload Questions Form -->
                    <form method="POST" action="{{ url_for('upload_quiz_questions', event_id=event.id, quiz_id=quiz.id) }}" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label fw-bold">Upload Questions (CSV)</label>
                            <input type="file" class="form-control" name="file" accept=".csv" required>
                            <div class="form-text">
                                <a href="{{ url_for('static', filename='sample_quiz_questions_v2.csv') }}" target="_blank">
                                    <i class="fas fa-download"></i> Download CSV Template
                                </a>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-upload"></i> Upload Questions
                        </button>
                    </form>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('add_quiz_question', event_id=event.id, quiz_id=quiz.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-plus-circle"></i> Add Question Manually
                        </a>
                    </div>

                    {% if total_questions > 0 %}
                    <hr>
                    <h6>Current Questions:</h6>
                    <div class="list-group">
                        {% for question in quiz.questions %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>Q{{ loop.index }}:</strong> {{ question.question[:80] }}{% if question.question|length > 80 %}...{% endif %}
                                    <br><small class="text-muted">Options: {{ question.get_options()|join(', ') }}</small>
                                    <br><small class="text-success"><i class="fas fa-check"></i> Correct: {{ question.correct_answer }}</small>
                                </div>
                                <div class="ms-3">
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion({{ question.id }}, '{{ question.question[:30]|e }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quiz Actions -->
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-play-circle"></i> Quiz Actions
                    </h5>
                </div>
                <div class="card-body">
                    {% if total_questions > 0 %}
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('generate_quiz_qr', event_id=event.id, quiz_id=quiz.id) }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-qrcode"></i> Generate QR Code
                        </a>
                        <a href="{{ url_for('quiz_results', quiz_id=quiz.id) }}" class="btn btn-success">
                            <i class="fas fa-trophy"></i> View Results & Winners
                        </a>
                        <a href="{{ url_for('join_quiz', quiz_id=quiz.id) }}" class="btn btn-info" target="_blank">
                            <i class="fas fa-external-link-alt"></i> Test Quiz (Preview)
                        </a>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Upload questions first to start the quiz
                    </div>
                    {% endif %}

                    <hr>
                    <h6>Quiz URL:</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ url_for('join_quiz', quiz_id=quiz.id, _external=True) }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Participants List -->
            {% if total_participants > 0 %}
            <div class="card shadow mt-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-users"></i> Recent Participants
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for participant in quiz.participants[:5] %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ participant.name }}</strong><br>
                                <small class="text-muted">{{ participant.email }}</small>
                            </div>
                            <div class="text-end">
                                {% if participant.completed_at %}
                                <span class="badge bg-success">Completed</span><br>
                                <small class="text-muted">Score: {{ participant.score }}</small>
                                {% else %}
                                <span class="badge bg-warning">In Progress</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if total_participants > 5 %}
                    <div class="text-center mt-2">
                        <small class="text-muted">... and {{ total_participants - 5 }} more participants</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('event_dashboard', event_id=event.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Event Dashboard
        </a>
    </div>
</div>

<script>
function copyToClipboard(button) {
    const input = button.parentElement.querySelector('input');
    input.select();
    document.execCommand('copy');
    
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

function deleteQuiz() {
    if (confirm('Are you sure you want to delete this entire quiz? This will remove all questions, participants, and answers. This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_quiz", event_id=event.id, quiz_id=quiz.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteQuestion(questionId, questionText) {
    if (confirm(`Are you sure you want to delete this question?\n\n"${questionText}"\n\nThis will also remove all answers to this question. This action cannot be undone.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/event/{{ event.id }}/quiz/{{ quiz.id }}/question/${questionId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}